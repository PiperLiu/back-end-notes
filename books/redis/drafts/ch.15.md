# 第 15 章 复制

<!-- @import "[TOC]" {cmd="toc" depthFrom=3 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [15.1 旧版复制功能的实现](#151-旧版复制功能的实现)
  - [15.1.1 同步](#1511-同步)
  - [15.1.2 命令传播](#1512-命令传播)
  - [15.2 旧版复制功能的缺陷](#152-旧版复制功能的缺陷)
- [15.3 新版复制功能的实现](#153-新版复制功能的实现)
- [15.4 部分重同步的实现](#154-部分重同步的实现)
  - [15.4.1 复制偏移量](#1541-复制偏移量)
  - [15.4.2 复制积压缓冲区](#1542-复制积压缓冲区)
  - [15.4.3 服务器运行ID](#1543-服务器运行id)
- [15.5 PSYNC 命令的实现](#155-psync-命令的实现)
- [15.6 复制的实现](#156-复制的实现)
  - [15.6.1 步骤1：设置主服务器的地址和端口](#1561-步骤1设置主服务器的地址和端口)
  - [15.6.2 步骤2：建立套接字连接](#1562-步骤2建立套接字连接)
  - [15.6.3 步骤3：发送PING命令](#1563-步骤3发送ping命令)
  - [15.6.4 步骤4：身份验证](#1564-步骤4身份验证)
  - [15.6.5 步骤5：发送端口信息](#1565-步骤5发送端口信息)
  - [15.6.6 步骤6：同步](#1566-步骤6同步)
  - [15.6.7 步骤7：命令传播](#1567-步骤7命令传播)
- [15.7 心跳检测](#157-心跳检测)
  - [15.7.1 检测主从服务器的网络连接状态](#1571-检测主从服务器的网络连接状态)
  - [15.7.2 辅助实现min-slaves配置选项](#1572-辅助实现min-slaves配置选项)
  - [15.7.3 检测命令丢失](#1573-检测命令丢失)

<!-- /code_chunk_output -->

```bash
127.0.0.1:12345> SLAVEOF 127.0.0.1 6379
```

### 15.1 旧版复制功能的实现

#### 15.1.1 同步

从服务器发送 SYNC 命令，主服务器执行 BGSAVE 命令，并将 RDB 文件发送给从服务器。

#### 15.1.2 命令传播

主服务器为了保持数据一致性，会将命令传播给从服务器。

#### 15.2 旧版复制功能的缺陷

SYNC 命令极其耗费资源。

### 15.3 新版复制功能的实现

从 Redis 2.8 开始，Redis 提供了新的复制功能，称为 PSYNC 命令：
- full resynchronization：全量同步，和 SYNC 基本一致
- partial resynchronization：部分同步，处理断线重连情况
  - 重连后，从服务器发送 `PSYNC` ，主服务器发送 `+CONTINUE` 回复，开始部分同步
  - 从哪里部分同步？使用偏移量概念

### 15.4 部分重同步的实现

#### 15.4.1 复制偏移量

主服务器每次向从服务器传播 N 个字节的数据时，就会将自己的偏移量的值加上 N ；从服务器每次接收到 N 个字节的数据时，就会将自己的偏移量的值加上 N 。

#### 15.4.2 复制积压缓冲区

一个 FIFO 队列，保存主服务器传播给从服务器的命令。根据偏移量，从服务器可以判断自己缺少哪些命令。

#### 15.4.3 服务器运行ID

### 15.5 PSYNC 命令的实现

### 15.6 复制的实现

#### 15.6.1 步骤1：设置主服务器的地址和端口

#### 15.6.2 步骤2：建立套接字连接

#### 15.6.3 步骤3：发送PING命令

#### 15.6.4 步骤4：身份验证

#### 15.6.5 步骤5：发送端口信息

#### 15.6.6 步骤6：同步

#### 15.6.7 步骤7：命令传播

### 15.7 心跳检测

#### 15.7.1 检测主从服务器的网络连接状态

#### 15.7.2 辅助实现min-slaves配置选项

```cfg
min-slaves-to-write 3
min-slaves-max-lag 10
```

代表当然从服务器数量小于 3 个或 3 个从服务器的延迟都大于等于 10 秒，则主服务器会拒绝写命令。

#### 15.7.3 检测命令丢失

