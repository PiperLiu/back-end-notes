原文链接：
- [vim替换命令](https://zhuanlan.zhihu.com/p/102387120)
- [VIM模式中magic选项剖析](https://zhuanlan.zhihu.com/p/56991272)


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [vim基础替换命令](#vim基础替换命令)
  - [1 语法](#1-语法)
  - [2 range](#2-range)
  - [3 source与target](#3-source与target)
  - [4 option](#4-option)
  - [5 总结](#5-总结)
- [融入正则](#融入正则)
  - [VIM模式中magic选项剖析](#vim模式中magic选项剖析)
  - [举例子（正则组属性）](#举例子正则组属性)

<!-- /code_chunk_output -->

## vim基础替换命令

### 1 语法

```
:[range]s/source/target/[option]
```

### 2 range

`range`表示要替换的范围,想要全局替换的话,可以使用一个百分号.

```
:%s/xxx/xxxx
```

另外,小数点表示当前行,美元符号表示最后一行,数字表示范围.

```
:1,.s     替换第一行到当前行
:.,$s     替换当前行到最后一行
:1,$s     替换第一行到最后一行,相当于 :%s
```

### 3 source与target

表示源字符串与目标字符串,如
```
:1,.s/123/456
```

表示把第一行到当前行的首次出现的123替换成456,注意是首次出现,如果要替换某一行全部源字符串需要在后面加上

```
/g
```

另外,对于一些特殊字符比如小数点,斜杠,双引号等需要转义,方式是使用反斜杠,在需要转义的字符面前加一个反斜杠 如把
```
"123//"
```

替换为
```
'123\\'
```


命令如下:
```
:s/\"123\/\/\"/\'123\\\\\'/g
```

因为
```
"123//" 中
"     转义为      \"
/     转义为      \/
'123\\' 中
'     转义为      \'
\     转义为      \\
```

### 4 option

选项如下:

- `/g`  全局替换
- `/c`  确认
- `/p`  替换结果逐行显示

注意选项的组合结果是

- `/cg`
- `/pc`

这样的形式,而不是 `/c/g` 、 `/g/p` 这样的形式.

### 5 总结

全局替换的话,使用
```
:%s/source/target/g
```

局部替换的话,使用
```
:n,ms/source/target
```

n,m为行数,表示要替换的范围. 注意如果字符串需要转义要加上反斜杠.

## 融入正则

### VIM模式中magic选项剖析

VIM的`/`或`?`，和`:s`、`:g`、`:v`，可借助模式匹配来完成复杂的搜索，以及建立在搜索之上的替换和执行命令。提到模式大家肯定会想到功能强大的正则表达式，VIM也确实支持自己风格的正则表达式。但是考虑到使用者不一定总是要使用正则表达式，对于只想原原本本按用户指定文本做简单的搜索和替换来说，正则表达式中大量字符被定义为具有特殊含义的元字符（元字符为描述字符的字符，它不直接表示该字符本身）会造成诸多不便：比如想搜索文本“`$5.2*3`”，因为`$.*`都有特别的含义，不改写的情况下永远不会有预期结果，而正确搜索需要写成“`\$5\.2\*3`”，对普通用户来说非常不友好。

为兼顾以字符主要表示本身，以及大量运用元字符这两种完全不同的倾向，VIM对于模式提供了4种选项，来分别表明哪些字符（仅限于ASCII中字母、数字、下划线、空格以外的可见字符）开始的字符序列具有特殊含义，哪些表示字符本身。VIM在提供灵活性的同时，也增加了正确写出模式的难度。以下内容根据VIM帮助，结合个人观点，对4种选项加以简单梳理，希望能便于大家记忆及正确运用VIM模式。

4种选项分别为：very magic、magic、nomagic、very nomagic。其中magic、nomagic可以通过set设置为模式的默认选项，而所有4种选项皆可在模式中多次通过开关来临时切换：

- `\v very magic`
- `\m magic`
- `\M nomagic`
- `\V very nomagic`

如果环境set magic的话，则搜索：
```
/abc\vdef\Vghi\Mjkl
```
表示按magic解释abc，按very magic解释def，按very nomagic解释ghi，按nomagic解释jkl。

VIM官方推荐设置为magic，然后需要使用其他选项时用开关切换。

4种选项中，带有no的倾向字符表示字符本身，而不带no的倾向字符具有特殊含义；带有very的则处于两个极端，不带very的居中。4种选项的具体区别：

- `\v`指定very magic：所有ASCII字符中（即键盘上能看到的字符），除了数字（`0-9`）、大小写字母（`A-Za-z`）和下划线（`_`）外，全都有特殊含义。
- `\V`指定very nomagic：大多数字符都表示其本身，除了反斜杠`\`，以及用来表示模式起止的分隔符（如/或?）。
- `\m`指定magic：`^ $ . * ~ []` 等具有特殊含义。当然，反斜杠和表达模式起止的分隔符也算具有特殊含义。
- `\M`指定nomagic：仅 `^ $` 具有特殊含义。当然，反斜杠和表达模式起止的分隔符也算具有特殊含义。

通过定义可以看出：
- \v适合大量运用正则表达式的场合；
- \V适用于完全不使用正则表达式的原文搜索；
- \m使用少量的正则表达式，包括起止锚点、任意字符、0次以上出现、最近匹配以及字符组；
- \M仅使用^$来完成整行匹配或特定开头、结尾。

其他注意事项：
- 由于反斜杠`\`肩负标示转义序列开始的特殊使命，在4种选项下`\`字符本身都要用`\\`表示。
- 字母、数字、下划线开始的字符序列总表示字符本身，而由`\`开始后接字母、数字、下划线字符序列，不管该转义序列有无特殊含义（如`\d`表示数字`0-9`，`\y`则仅表示字符`y`），在4种选项下均具有相同的写法，也始终和正则表达式保持一致。
- 除字母、数字、下划线和空格以外的字符（假设其为`$`）则因选项而异：若某选项下默认它具有特殊含义，则`$`直接表示特殊含义，`\$`表示`$`字符本身；若某选项下默认它没有特殊含义，则`$`表示`$`字符本身，`\$`表示特殊含义（也是`$`在正则表达式中的含义）。当`$`在正则表达式中尚未拥有特殊含义时，则所谓特殊含义也因此而变为字符本身。
- 如果某字符用于模式的分隔符（搜索分隔符有`/`和`?`两种，`:s :g :v`命令则可自定义除`\"|`之外的其他单个字符作为模式分隔符，默认为`/`），则不管它在VIM正则表达式中是否拥有特殊含义，都无法再用该字符表示正则特殊含义，因为它的第一特殊含义已变为更为优先的模式分隔符，跟在\后则表示该字符本身（总得让每个选项下每个字符本身能得以表达）。比如：以?开始的搜索，`\?`表示问号本身，再出现直接的`?`表示搜索模式结束，表示0次或1次的量词已无从表达。使用`/`则不会出现这个问题，因为正则表达式中/的特殊含义也是分隔符，因此推荐总是使用/作为模式分隔符，只在不想用正则的情况下，待匹配模式中常出现/字符本身时，才推荐换用其他分隔符。
- 当使用具有正则表达式意义的元字符括号时，在需要转义的选项下，开始括号`([{`必须前加`\`，结束括号中，`)`必须前加`\`，`]`必须前不加`\` `（\]`专门在字符组中表示`]`字符），`}`则可在前面加或不加`\`。

### 举例子（正则组属性）

```
C++ 中 `sort` 函数 怎么会造成 `heap-overflow` 呢？
```

给上述行的英文单词加反引号。

```
:.s/([a-z\-]+)/`\1`/g
当前行/字符范围/用反引号包括\1组/所有的
```
