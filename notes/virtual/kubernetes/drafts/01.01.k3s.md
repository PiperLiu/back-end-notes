# 认识 k3s

<!-- @import "[TOC]" {cmd="toc" depthFrom=3 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [k3s 亮点](#k3s-亮点)
- [初始 k3s （如何查看 k3s 启动？）](#初始-k3s-如何查看-k3s-启动)
- [k3s 代码组织架构](#k3s-代码组织架构)
  - [k3s 如何保证高可用？](#k3s-如何保证高可用)
- [k3s 实例（使用 multipass 虚拟机）](#k3s-实例使用-multipass-虚拟机)

<!-- /code_chunk_output -->

参考：
- [从0到1基础入门 全面了解k3s](https://www.bilibili.com/video/BV1g7411G7By)
- https://k3s.io/
- https://docs.rancher.cn/docs/k3s/quick-start/_index 含国内镜像资源
- [从0到1基础入门 全面了解k3s](https://www.bilibili.com/video/BV1g7411G7By)
- [k3s高可用架构、Containerd](https://www.bilibili.com/video/BV197411c759)

### k3s 亮点

相比 k8s ， k3s 降低了通用性（比如由于历史原因保留了很多驱动）、删除了冗余的 API 、使用单进程架构简化部署（将很多进程改为 go 协程）。

k3s 默认使用 Containerd 而非 Docker 。

### 初始 k3s （如何查看 k3s 启动？）

我最终还是用的 Azure ，这样下载 github 文件在一瞬间完成。

```bash
(base) PiperLiu1998@rlco-promo:~$ curl -sfL https://get.k3s.io | sh -
[INFO]  Finding release for channel stable
[INFO]  Using v1.23.6+k3s1 as release
[INFO]  Downloading hash https://github.com/k3s-io/k3s/releases/download/v1.23.6+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/k3s-io/k3s/releases/download/v1.23.6+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Skipping installation of SELinux RPM
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
[INFO]  systemd: Starting k3s

# sudo k3s kubectl get node
(base) PiperLiu1998@rlco-promo:~$ sudo k3s kubectl get node
NAME         STATUS   ROLES                  AGE   VERSION
rlco-promo   Ready    control-plane,master   73s   v1.23.6+k3s1
# sudo kubectl get ns
(base) PiperLiu1998@rlco-promo:~$ sudo kubectl get ns
NAME              STATUS   AGE
default           Active   99s
kube-system       Active   99s
kube-public       Active   99s
kube-node-lease   Active   99s
(base) PiperLiu1998@rlco-promo:~$
```

如何判定 k3s 是否启动？

```bash
# 可以看日志
tail -f /var/log/syslog

# 看 k3s 核心组件
kubectl get all -n kube-system
```

### k3s 代码组织架构

![](./images/20220617k3s01.png)

如上， Angent 的 containerd 会启动一个 `exec.Command` 作为自己的子进程（ Containerd 是一个独立的进程 ）。

为什么有 StartServer 直接用虚线连到 run ？如果我们 k3s server 启动时也会作为一个 node ，如果 disable server （不应用 `run` ）则会成为一个裸的 server 。

#### k3s 如何保证高可用？

外置数据。但也会带来局限性：
- 需要额外的资源支持
- 需要运维人员进行维护
- 可能面临不可用情况

因此，是否可以给 k3s 应用分布式数据库？

了解一下 SQLite ：
- 不是独立的进程，而是 c 编写的库文件
- 在 k3s 中利用 c-go 可以直接调用

基于 SQLite 有了 Dqlite ：
- 也是软件库，而非独立进程， c 编写
- 分布式一致： C-Raft 实现
- 兼容 SQLite

![](./images/20220617dqlite01.png)



### k3s 实例（使用 multipass 虚拟机）

https://asciinema.org/a/OFaQIHuye4AU5QBaEgzUFq9ql
- 在本地的 docker 起一个 mysql 作为外部数据库
- 在本地的做两个 multipass 虚拟机作为两台 server
- 在本地的 docker 起一个 nigix 作为 4l 负载


安装 multipass 虚拟机。

```bash
azureuser@StdUbuntu:~$ sudo snap install multipass
2022-06-17T03:22:18Z INFO Waiting for automatic snapd restart...
multipass 1.9.2 from Canonical✓ installed
azureuser@StdUbuntu:~$ multipass version
multipass   1.9.2
multipassd  1.9.2
```

